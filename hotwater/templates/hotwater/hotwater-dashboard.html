<!DOCTYPE html>
<html lang="en">
<head>
    <title>Heating Zone</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/Mikhus/canvas-gauges/gh-pages/download/2.1.5/all/gauge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
    <script type="text/javascript">
        $( document ).ready(setupCharts);

        var offset = new Date().getTimezoneOffset() * 60 * 1000;

        const wheat1_in_sensor = 'WHEAT1-IN';
        const wheat1_out_sensor = 'WHEAT1-OUT';
        const wheat1_burn_sensor = 'WHEAT1-BURN';
        var wheat1_gauge_in;
        var wheat1_gauge_out;
        var wheat1_gauge_burn;
        var wheat1_chart;

        const wheat2_in_sensor = 'WHEAT2-IN';
        const wheat2_out_sensor = 'WHEAT2-OUT';
        const wheat2_burn_sensor = 'WHEAT2-BURN';
        var wheat2_gauge_in;
        var wheat2_gauge_out;
        var wheat2_gauge_burn;
        var wheat2_chart;

        const circ_in_sensor = 'HOT-WATER-RETURN';
        const circ_pump_name = 'HWCIRCPUMP';
        var circ_gauge;
        var circ_pump;
        var circ_chart;

        var ts;

		var chartConfig = {
			type: 'line',
			data: {
				datasets: [{
					label: 'IN',
                    borderColor: 'orange',
					fill: false,
                    pointRadius: 0,
					data: [],
				}, {
					label: 'OUT',
                    borderColor: 'skyblue',
					fill: false,
                    pointRadius: 0,
					data: [],
				}, {
					label: 'BURN',
                    borderColor: 'red',
					fill: false,
                    pointRadius: 0,
					data: [],
				}]
			},
			options: {
			    maintainAspectRatio: false,
				scales: {
					xAxes: [{
						type: 'time',
                        ticks: {
                            stepSize: 10
                        },
                        time: {
						    unit: 'minute',
                            displayFormats: { minute: 'MM-DD HH:mm' }
                        },
						scaleLabel: {
							display: true,
							labelString: 'Time'
						}
					}],
					yAxes: [{
					    ticks: {
                            suggestedMin: 30,
                            suggestedMax: 180,
                            stepSize: 30
                        },
						scaleLabel: {
							display: true,
							labelString: 'temp'
						}
					}]
				},
			}
		};


        function wheat1DrawCharts() {
            wheat1_gauge_in.draw();
            wheat1_gauge_out.draw();
            wheat1_gauge_burn.draw();
            wheat1_chart.update();
        }

        function wheat2DrawCharts() {
            wheat2_gauge_in.draw();
            wheat2_gauge_out.draw();
            wheat2_gauge_burn.draw();
            wheat2_chart.update();
        }

        function circDrawCharts() {
            circ_gauge.draw();
            circ_pump.draw();
            circ_chart.update();
        }


        function wheat1StartData(adata) {
            for (let sensor in adata['data']) {
                let slist = adata['data'][sensor]['data'];
                let numpts = slist.length;
                if (numpts > 0) {
                    if (sensor.endsWith('-IN') || sensor.endsWith('-INSYS')) {
                        wheat1_gauge_in.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat1_chart.data.datasets[0].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    } else if (sensor.endsWith('-OUT')) {
                        wheat1_gauge_out.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat1_chart.data.datasets[1].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    } else if (sensor.endsWith('-BURN')) {
                        wheat1_gauge_burn.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat1_chart.data.datasets[2].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    }
                }
            }
            wheat1DrawCharts();
            setTimeout(wheat1StartUpdate, 10000);
        }


        function wheat1UpdateData(adata) {
            for (let sensor in adata['data']) {
                let slist = adata['data'][sensor]['data'];
                let numpts = slist.length;
                if (numpts > 0) {
                    if (sensor.endsWith('-IN') || sensor.endsWith('-INSYS')) {
                        wheat1_gauge_in.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat1_chart.data.datasets[0].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[0].data.length - 9000; i++) {
                            wheat1_chart.data.datasets[0].data.shift();
                        }
                    } else if (sensor.endsWith('-OUT')) {
                        wheat1_gauge_out.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat1_chart.data.datasets[1].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[0].data.length - 9000; i++) {
                            wheat1_chart.data.datasets[1].data.shift();
                        }
                    } else if (sensor.endsWith('-BURN')) {
                        wheat1_gauge_burn.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat1_chart.data.datasets[2].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[2].data.length - 9000; i++) {
                            wheat1_chart.data.datasets[2].data.shift();
                        }
                    }
                }
            }
            wheat1DrawCharts();
            setTimeout(wheat1StartUpdate, 5000);
        }


        function wheat1StartUpdate() {
		    let sts = new Date(ts);
            ts = new Date();
            $.getJSON('{{ host }}/heating/api/zones/{{ zone }}/data',
                { 'starttime': sts.toISOString(), 'endtime': ts.toISOString(), 'datapts': 9000 },
                wheat1UpdateData);
        }


        function setupWheat1() {
            wheat1_gauge_in = new RadialGauge({renderTo: 'wheat1_gauge_in_div',
                title: 'WH1-IN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 180, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            wheat1_gauge_out = new RadialGauge({renderTo: 'wheat1_gauge_out_div',
                title: 'WH1-OUT',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 180, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            wheat1_gauge_burn = new RadialGauge({renderTo: 'wheat1_gauge_burn_div',
                title: 'WH1-BURN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 270,
                majorTicks: ['30', '60', '90', '120', '150', '180', '210', '240', '270'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 270, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            var ctx = document.getElementById('wheat1_chart_div').getContext('2d');
            wheat1_chart = new Chart(ctx, chartConfig);
            let sts = new Date();
            ts = new Date(sts);
            sts.setHours(sts.getHours() - 24);
            $.getJSON('{{ host }}/sensors/api/sensors/' + wheat1_in_sensor + '/data',
                {'starttime': sts.toISOString(), 'endtime': ts.toISOString(), 'datapts': 9000 },
                wheat2StartData);
        }


        function wheat2StartData(adata) {
            for (let sensor in adata['data']) {
                let slist = adata['data'][sensor]['data'];
                let numpts = slist.length;
                if (numpts > 0) {
                    if (sensor.endsWith('-IN') || sensor.endsWith('-INSYS')) {
                        wheat2_gauge_in.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat2_chart.data.datasets[0].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    } else if (sensor.endsWith('-OUT')) {
                        wheat2_gauge_out.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat2_chart.data.datasets[1].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    } else if (sensor.endsWith('-BURN')) {
                        wheat2_gauge_burn.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = 0; i < numpts; i++) {
                            wheat2_chart.data.datasets[2].data.unshift({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                    }
                }
            }
            wheat2DrawCharts();
            setTimeout(wheat2StartUpdate, 10000);
        }


        function wheat2UpdateData(adata) {
            for (let sensor in adata['data']) {
                let slist = adata['data'][sensor]['data'];
                let numpts = slist.length;
                if (numpts > 0) {
                    if (sensor.endsWith('-IN') || sensor.endsWith('-INSYS')) {
                        wheat2_gauge_in.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat2_chart.data.datasets[0].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[0].data.length - 9000; i++) {
                            wheat2_chart.data.datasets[0].data.shift();
                        }
                    } else if (sensor.endsWith('-OUT')) {
                        wheat2_gauge_out.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat2_chart.data.datasets[1].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[0].data.length - 9000; i++) {
                            wheat2_chart.data.datasets[1].data.shift();
                        }
                    } else if (sensor.endsWith('-BURN')) {
                        wheat2_gauge_burn.value = slist[0]['attributes']['value'];
                        // reverse load
                        for (let i = numpts-1; i >= 0; i--) {
                            wheat2_chart.data.datasets[2].data.push({t: slist[i]['attributes']['timestamp']-offset, y: slist[i]['attributes']['value']});
                        }
                        // remove extras
                        for (let i = 0; i < lineChart.data.datasets[2].data.length - 9000; i++) {
                            wheat2_chart.data.datasets[2].data.shift();
                        }
                    }
                }
            }
            wheat2DrawCharts();
            setTimeout(wheat2StartUpdate, 5000);
        }


        function wheat2StartUpdate() {
		    let sts = new Date(ts);
            ts = new Date();
            $.getJSON('{{ host }}/heating/api/zones/{{ zone }}/data',
                { 'starttime': sts.toISOString(), 'endtime': ts.toISOString(), 'datapts': 9000 },
                wheat2UpdateData);
        }


        function setupWheat2() {
            wheat2_gauge_in = new RadialGauge({renderTo: 'wheat2_gauge_in_div',
                title: 'WH2-IN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 180, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            wheat2_gauge_out = new RadialGauge({renderTo: 'wheat2_gauge_out_div',
                title: 'WH2-OUT',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 180, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            wheat2_gauge_burn = new RadialGauge({renderTo: 'wheat2_gauge_burn_div',
                title: 'WH2-BURN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 270,
                majorTicks: ['30', '60', '90', '120', '150', '180', '210', '240', '270'],
                minorTicks: 6,
                highlights: [{ from: 30, to: 60, color: 'skyblue' },
                    { from: 60, to: 90, color: 'aliceblue' },
                    { from: 90, to: 120, color: 'yellow' },
                    { from: 120, to: 150, color: 'orange' },
                    { from: 150, to: 270, color: 'red' }
                ],
                valueBox: true,
                value: 30});
            var ctx = document.getElementById('wheat2_chart_div').getContext('2d');
            wheat2_chart = new Chart(ctx, chartConfig);
            let sts = new Date();
            ts = new Date(sts);
            sts.setHours(sts.getHours() - 24);
            $.getJSON('{{ host }}/sensors/api/sensors/' + wheat2_in_sensor + '/data',
                {'starttime': sts.toISOString(), 'endtime': ts.toISOString(), 'datapts': 9000 },
                wheat2StartData);
        }


        function setupCirc() {
            gaugeIn = new RadialGauge({
                renderTo: 'wheat2_gauge_in_div',
                title: 'IN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{from: 30, to: 60, color: 'skyblue'},
                    {from: 60, to: 90, color: 'aliceblue'},
                    {from: 90, to: 120, color: 'yellow'},
                    {from: 120, to: 150, color: 'orange'},
                    {from: 150, to: 180, color: 'red'}
                ],
                valueBox: true,
                value: 30
            });
            gaugeOut = new RadialGauge({
                renderTo: 'wheat2_gauge_out_div',
                title: 'OUT',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 180,
                majorTicks: ['30', '60', '90', '120', '150', '180'],
                minorTicks: 6,
                highlights: [{from: 30, to: 60, color: 'skyblue'},
                    {from: 60, to: 90, color: 'aliceblue'},
                    {from: 90, to: 120, color: 'yellow'},
                    {from: 120, to: 150, color: 'orange'},
                    {from: 150, to: 180, color: 'red'}
                ],
                valueBox: true,
                value: 30
            });
            gaugeBurn = new RadialGauge({
                renderTo: 'wheat2_gauge_burn_div',
                title: 'BURN',
                width: 250, height: 250,
                units: 'F', minValue: 30, maxValue: 270,
                majorTicks: ['30', '60', '90', '120', '150', '180', '210', '240', '270'],
                minorTicks: 6,
                highlights: [{from: 30, to: 60, color: 'skyblue'},
                    {from: 60, to: 90, color: 'aliceblue'},
                    {from: 90, to: 120, color: 'yellow'},
                    {from: 120, to: 150, color: 'orange'},
                    {from: 150, to: 270, color: 'red'}
                ],
                valueBox: true,
                value: 30
            });
            var ctx = document.getElementById('wheat2_chart_div').getContext('2d');
            lineChart = new Chart(ctx, chartConfig);
            let sts = new Date();
            ts = new Date(sts);
            sts.setHours(sts.getHours() - 24);
            $.getJSON('{{ host }}/heating/api/zones/{{ zone }}/data',
                {'starttime': sts.toISOString(), 'endtime': ts.toISOString(), 'datapts': 9000},
                wheat2StartData);
        }


        function setupRelay() {

        }


        function setupCharts() {
            setupWheat1();
            setupWheat2();
        }

    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Zone {{ zone }}</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="{% url 'view_heating_dashboard' %}">Heating<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'view_hotwater_dashboard' %}">Hot Water<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'view_devices_dashboard' %}">Sensors<span class="sr-only">(current)</span></a>
        </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Zones
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                {% for zone in zones %}
                  <a class="dropdown-item" href="{% url 'view_heating_zone' zone.name %}">{{ zone.name }}</a>
                {% endfor %}
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container-fluid mt-3">
        <div class="row mt-3">
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat1_gauge_in_div" style="width: 100%;"></canvas>
            </div>
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat1_gauge_out_div" style="width: 100%;"></canvas>
            </div>
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat1_gauge_burn_div" style="width: 100%;"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <canvas id="wheat1_chart_div" style=" width: 100%; height: 400px"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat2_gauge_in_div" style="width: 100%;"></canvas>
            </div>
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat2_gauge_out_div" style="width: 100%;"></canvas>
            </div>
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="wheat2_gauge_burn_div" style="width: 100%;"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <canvas id="wheat2_chart_div" style=" width: 100%; height: 400px"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="return_gauge_div" style="width: 100%;"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <canvas id="return_chart_div" style=" width: 100%; height: 400px"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-sm-4 col-lg-4 col-xl-2">
                <canvas id="relay_div" style="width: 100%;"></canvas>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <canvas id="relay_chart_div" style=" width: 100%; height: 400px"></canvas>
            </div>
        </div>
    </div>
</body>
</html>
