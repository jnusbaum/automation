<!DOCTYPE html>
<html lang="en">
<head>
    <title>Heating Zone</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'line', 'gauge']});
      google.charts.setOnLoadCallback(setupChart);

      var goptions = {
        width: 600, height: 300,
        greenFrom: 90, greenTo: 120,
        greenColor: "yellow",
        yellowFrom:120, yellowTo: 150,
        yellowColor: "orange",
        redFrom: 150, redTo: 200,
        minorTicks: 5,
        max: 200
      };
      var gdata;
      var gauges;
      var coptions = {
          chartArea: {width: '90%', height: '80%'},
          title: 'Last 24 Hours',
          legend: {position: 'in'},
          hAxis: {
              title: 'Time',
          },
          vAxis: {
              title: 'Temperature',
              maxValue: 200,
              minValue: 30
          },
          colors: ['orange', 'skyblue']
      };
      var cdata;
      var chart;
      var ts;


      function strToDate(ts) {
          var year = Number(ts.substr(0, 4));
          var month = Number(ts.substr(5, 2));
          var day = Number(ts.substr(8, 2));
          var hour = Number(ts.substr(11, 2));
          var minute = Number(ts.substr(14, 2));
          var second = Number(ts.substr(17, 2));

          return new Date(year, month, day, hour, minute, second);
      }


      function drawCharts() {
          gauges.draw(gdata, goptions);
          chart.draw(cdata, coptions);
      }


      function updateOut(data) {
          gdata.setValue(1, 1, Number(data.data[0].attributes.value_real));
          for (let i=0; i < 9000; i++) {
              cdata.setValue(i, 2, Number(data.data[i].attributes.value_real));
          }
          drawCharts();

          ts = curDateStr();
          setTimeout(updateData, 15000);
      }


      function updateIn(data) {
          gdata.setValue(0, 1, Number(data.data[0].attributes.value_real));
          for (let i=0; i < 9000; i++) {
              cdata.setValue(i, 0, strToDate(data.data[i].attributes.timestamp));
              cdata.setValue(i, 1, Number(data.data[i].attributes.value_real));
          }
          $.getJSON('http://192.168.0.134/dataserver/sensors/{{ samples.zone }}-OUT/data',
                    { 'datapts': 9000, 'targettime': ts },
                    updateOut);
      }


      function updateData() {
          var ext = 'IN';
          if ('{{ samples.zone }}' == 'VALVE') {
              ext = 'INSYS';
          }
        $.getJSON('http://192.168.0.134/dataserver/sensors/{{ samples.zone }}-' + ext +'/data',
                    { 'datapts': 9000, 'targettime': ts },
                    updateIn);
      }


      function curDateStr() {
          var d = new Date();
          return d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" +
              ("0" + d.getDate()).slice(-2) + "-" + ("0" + d.getHours()).slice(-2) + "-" +
              ("0" + d.getMinutes()).slice(-2) + "-" + ("0" + d.getSeconds()).slice(-2);
      }


      function setupChart() {
        gauges = new google.visualization.Gauge(document.getElementById('gauge_div'));
        gdata = google.visualization.arrayToDataTable([['Label', 'Value'],
                                                        ['IN', 0],
                                                        ['OUT', 0]]);
        chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        cdata = new google.visualization.DataTable();
        cdata.addColumn('datetime', 'Time');
        cdata.addColumn('number', 'IN');
        cdata.addColumn('number', 'OUT');
        cdata.addRows(9000);

        ts = curDateStr();

        updateData(ts);
      }
    </script>
    <style>
        .hot {
            {# above 150 #}
            fill: red;
        }
        .very-warm {
            {# 130-150 #}
            fill: orange;
        }
        .warm {
            {# 110-130 #}
            fill: yellow;
        }
        .luke-warm {
            {# 90-110 #}
            fill: aliceblue;
        }
        .cool {
            {# 70-90 #}
            fill: skyblue;
        }
        .cold {
            {# below 70 #}
            fill: deepskyblue;
        }

        .vertical-center {
              margin: 0;
              position: absolute;
              top: 50%;
              -ms-transform: translateY(-50%);
              transform: translateY(-50%);
        }

        .center {
            text-align: center;
            vertical-align: center;
            border: aliceblue;
        }
    </style>

</head>
<body>
    <div class="jumbotron jumbotron-fluid">
        <div class="container-fluid">
            <h1>{{ samples.zone }} Zone Info</h1>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-4">
                <a href="{% url 'index' %}">dashboard</a>
            </div>
            <div class="col-4">
                <h6>{{ samples.badin }}</h6>
            </div>
            <div class="col-4">
                <h6>{{ samples.badout }}</h6>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div id="gauge_div" style="width: 100%;"></div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="chart_div" style="width: 100%; height: 750px;"></div>
            </div>
        </div>

    </div>

</body>
</html>
